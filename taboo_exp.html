<html>
    <head>
        <title>Taboo Experiment</title>
        <script src="jspsych-6.0.5/jspsych.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych-6.0.5/plugins/jspsych-call-function.js"></script>
        <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    </head>
    <body>
    </body>
    <script>


  /* High-level variables */
  var TURN_LENGTH = 5 * 1000  
  var TRIAL_LENGTH = 10 * 1000


  /* Set up timeline. */

    var timeline = [];

    var choice_array = ['Won', 'Discarded', 'Lost'];

    var startTime;

    var welcome_message = {
        type: 'html-keyboard-response',
        stimulus: 'Welcome to the Taboo Experiment. Press any key to begin session.',
        on_finish: function(){
          startTime=new Date();
        }
    }

    var pause_message = {
        type: 'html-keyboard-response',
        stimulus: 'Next Turn. Press any key.',
        on_finish: function(){
          startTime=new Date();
        }
    }

    timeline.push(welcome_message);


    blue_deck =  [{stimulus: 'Blue 1', data:{card: 'Blue 1'}},
                  {stimulus: 'Blue 2', data:{card: 'Blue 2'}},
                  {stimulus: 'Blue 3', data:{card: 'Blue 3'}},
                  {stimulus: 'Blue 4', data:{card: 'Blue 4'}},
                  {stimulus: 'Blue 5', data:{card: 'Blue 5'}},
                  {stimulus: 'Blue 6', data:{card: 'Blue 6'}},
                  {stimulus: 'Blue 7', data:{card: 'Blue 7'}},
                  {stimulus: 'Blue 8', data:{card: 'Blue 8'}},
                  {stimulus: 'Blue 9', data:{card: 'Blue 9'}},
                  {stimulus: 'Blue 10', data:{card: 'Blue 10'}}];



    //function to randomly sample from array
    function getRandom(arr, n) {
    var result = new Array(n),
    len = arr.length,
    taken = new Array(len);
    if (n > len)
    throw new RangeError("getRandom: more elements taken than available");
    while (n--) {
    var x = Math.floor(Math.random() * len);
    result[n] = arr[x in taken ? taken[x] : x];
    taken[x] = --len in taken ? taken[len] : len;
    }
    return result;
    }

    //blue_cards for 1st turn
    blue_cards1 = getRandom(blue_deck, 3);

    //blue_deck after 1 turn
    blue_deck1 = blue_deck.filter(function(val){
      return blue_cards1.indexOf(val) == -1;
    });


    var trial_timer = function() {
      endTime = new Date();
      var timer = setInterval(function () {
        endTime = new Date()
        if(endTime - startTime >= TURN_LENGTH){
          end_timeline = true
          alert("Time is up!")
          clearInterval(timer);
          jsPsych.finishTrial()
      }
      }, 1000);
    }

    var test_for_turn_end = function() {
      if(endTime - startTime >= TURN_LENGTH){
          jsPsych.endCurrentTimeline();
        }
    }

    //1st blue turn
    var blue_turn1 = {
      type: 'html-button-response',
      choices: choice_array,
      trial_duration: TRIAL_LENGTH, //max duration for one card
      timeline: blue_cards1,
      on_start: trial_timer,
      on_finish: test_for_turn_end
  }



    timeline.push(blue_turn1);

    timeline.push(pause_message);

    //blue_cards for 2nd turn
    blue_cards2 = getRandom(blue_deck1, 3);

    //blue_deck after 2 turns
    blue_deck2 = blue_deck1.filter(function(val){
      return blue_cards2.indexOf(val) == -1;
    });

    //2nd blue turn
    var blue_turn2 = {
    type: 'html-button-response',
    choices: choice_array,
    trial_duration: TRIAL_LENGTH,
    timeline: blue_cards2,
    on_start: trial_timer,
    on_finish: test_for_turn_end
  }

    timeline.push(blue_turn2);

    timeline.push(pause_message);

    //blue_cards for 3rd turn
    blue_cards3 = getRandom(blue_deck2, 3);

    //blue_deck after 3 turns
    blue_deck3 = blue_deck2.filter(function(val){
      return blue_cards3.indexOf(val) == -1;
    });

    //3rd blue turn
    var blue_turn3 = {
    type: 'html-button-response',
    choices: choice_array,
    trial_duration: TRIAL_LENGTH,
    timeline: blue_cards3,
    on_start: trial_timer,
    on_finish: test_for_turn_end
  
  }

      timeline.push(blue_turn3);

  timeline = [pause_message, blue_turn1, pause_message, blue_turn2, pause_message, blue_turn3]

  jsPsych.init({
    timeline: timeline,
    on_finish: function(data){ 
        //saveData(filename, jsPsych.data.get().csv());
        console.log(jsPsych.data.get().csv())
    }
    }
    );

    </script>
    </html>
